#!/bin/sh

# This script uses runs the AnnotationStatistics utility of the Checker
# Framework on the results of WPI on each checker for which annotations
# were inferred. It should be run on the wpi-annotations branch.
# You should make a copy of this script for each project being analyzed
# and modify it so that it works on that project - this is just a template.

### you may need to change these constants, depending on the project:

# the root of the wpi output
WPI_RESULTS_DIR=./wpi-annotations/

# the root of the java source files
JAVA_SRC_DIR=./src/main/java/

# the command to run AnnotationStatistics (should be the same command
# that is used to compile the target program)
RUN_ANNO_STATS="$JAVA_HOME/bin/javac -d /home/daniel/Research/experiments-live/alg-ref-impl-wpi/target/classes -classpath /home/daniel/Research/experiments-live/alg-ref-impl-wpi/target/classes:/home/daniel/.m2/repository/com/google/inject/guice/5.1.0/guice-5.1.0.jar:/home/daniel/.m2/repository/javax/inject/javax.inject/1/javax.inject-1.jar:/home/daniel/.m2/repository/aopalliance/aopalliance/1.0/aopalliance-1.0.jar:/home/daniel/.m2/repository/com/google/guava/guava/31.1-jre/guava-31.1-jre.jar:/home/daniel/.m2/repository/com/google/guava/failureaccess/1.0.1/failureaccess-1.0.1.jar:/home/daniel/.m2/repository/com/google/guava/listenablefuture/9999.0-empty-to-avoid-conflict-with-guava/listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar:/home/daniel/.m2/repository/com/google/code/findbugs/jsr305/3.0.2/jsr305-3.0.2.jar:/home/daniel/.m2/repository/com/google/errorprone/error_prone_annotations/2.11.0/error_prone_annotations-2.11.0.jar:/home/daniel/.m2/repository/com/google/j2objc/j2objc-annotations/1.3/j2objc-annotations-1.3.jar:/home/daniel/.m2/repository/org/apache/commons/commons-math3/3.6.1/commons-math3-3.6.1.jar:/home/daniel/.m2/repository/com/google/errorprone/error_prone_core/2.18.0/error_prone_core-2.18.0.jar:/home/daniel/.m2/repository/com/google/errorprone/error_prone_annotation/2.18.0/error_prone_annotation-2.18.0.jar:/home/daniel/.m2/repository/com/google/errorprone/error_prone_type_annotations/2.18.0/error_prone_type_annotations-2.18.0.jar:/home/daniel/.m2/repository/com/google/errorprone/error_prone_check_api/2.18.0/error_prone_check_api-2.18.0.jar:/home/daniel/.m2/repository/io/github/java-diff-utils/java-diff-utils/4.0/java-diff-utils-4.0.jar:/home/daniel/.m2/repository/org/eclipse/jgit/org.eclipse.jgit/4.4.1.201607150455-r/org.eclipse.jgit-4.4.1.201607150455-r.jar:/home/daniel/.m2/repository/com/github/kevinstern/software-and-algorithms/1.0/software-and-algorithms-1.0.jar:/home/daniel/.m2/repository/com/github/ben-manes/caffeine/caffeine/3.0.5/caffeine-3.0.5.jar:/home/daniel/.m2/repository/org/pcollections/pcollections/3.1.4/pcollections-3.1.4.jar:/home/daniel/.m2/repository/com/google/auto/auto-common/1.2.1/auto-common-1.2.1.jar:/home/daniel/.m2/repository/org/checkerframework/dataflow-errorprone/3.27.0/dataflow-errorprone-3.27.0.jar:/home/daniel/.m2/repository/com/google/auto/value/auto-value-annotations/1.9/auto-value-annotations-1.9.jar:/home/daniel/.m2/repository/com/google/protobuf/protobuf-java/3.19.2/protobuf-java-3.19.2.jar:/home/daniel/.m2/repository/com/google/auto/service/auto-service-annotations/1.0.1/auto-service-annotations-1.0.1.jar:/home/daniel/.m2/repository/org/checkerframework/checker/3.29.1-SNAPSHOT/checker-3.29.1-SNAPSHOT.jar:/home/daniel/.m2/repository/org/checkerframework/checker-util/3.29.1-SNAPSHOT/checker-util-3.29.1-SNAPSHOT.jar:/home/daniel/.m2/repository/org/checkerframework/checker-qual/3.29.1-SNAPSHOT/checker-qual-3.29.1-SNAPSHOT.jar: -sourcepath /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java:/home/daniel/Research/experiments-live/alg-ref-impl-wpi/target/generated-sources/annotations: /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/queue/Heap.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/LessThan.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/shell/Shell.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/tree/Tree.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/graph/AdjacencyList.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/graph/Direction.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/bubble/Bubble.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/quick/FinalElement.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/SinglyLinkedUnsortedDictionary.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/PriorityQueue.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/Dictionary.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/SortedDictionary.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/quick/Pivot.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/tree/BinaryTree.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/SinglyLinkedSortedDictionary.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/quick/PartitionStrategy.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/Cursor.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/graph/GraphOperations.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/DoublyLinkedSortedDictionary.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/graph/AdjacencyMatrix.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/graph/Edge.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/Swap.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/quick/Partition.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/heap/MinHeap.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/heap/PriorityQueue.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/quick/Element.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/type/NotInPlace.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/insertion/Insertion.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/Stack.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/type/InPlace.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/FromLeft.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/table/StringHashTable.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/merge/Natural.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/Range.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/graph/Traversable.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/GreaterThan.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/selection/Selection.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/quick/Quick.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/graph/Vertex.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/tree/NodeType.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/util/Math.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/UnsortedDictionary.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/heap/BinaryTree.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/Pair.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/Algorithm.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/DictionaryItem.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/merge/RunStrategy.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/FromRight.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/DoublyLinkedUnsortedDictionary.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/merge/TopDownMerge.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/Direction.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/type/Queue.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/util/Printer.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/App.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/quick/Movable.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/Index.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/merge/Run.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/sort/alg/merge/RunSlice.java /home/daniel/Research/experiments-live/alg-ref-impl-wpi/src/main/java/dev/thinke/domain/data/queue/PriorityQueue.java -s /home/daniel/Research/experiments-live/alg-ref-impl-wpi/target/generated-sources/annotations -processor org.checkerframework.common.util.count.AnnotationStatistics -processorpath /home/daniel/.m2/repository/com/google/errorprone/error_prone_core/2.18.0/error_prone_core-2.18.0.jar:/home/daniel/.m2/repository/org/checkerframework/checker/3.29.1-SNAPSHOT/checker-3.29.1-SNAPSHOT.jar:/home/daniel/.m2/repository/org/checkerframework/checker-qual/3.29.1-SNAPSHOT/checker-qual-3.29.1-SNAPSHOT.jar:/home/daniel/.m2/repository/org/checkerframework/checker-util/3.29.1-SNAPSHOT/checker-util-3.29.1-SNAPSHOT.jar:/home/daniel/.m2/repository/com/google/errorprone/error_prone_annotation/2.18.0/error_prone_annotation-2.18.0.jar:/home/daniel/.m2/repository/com/google/guava/guava/31.0.1-jre/guava-31.0.1-jre.jar:/home/daniel/.m2/repository/com/google/guava/failureaccess/1.0.1/failureaccess-1.0.1.jar:/home/daniel/.m2/repository/com/google/guava/listenablefuture/9999.0-empty-to-avoid-conflict-with-guava/listenablefuture-9999.0-empty-to-avoid-conflict-with-guava.jar:/home/daniel/.m2/repository/com/google/code/findbugs/jsr305/3.0.2/jsr305-3.0.2.jar:/home/daniel/.m2/repository/com/google/errorprone/error_prone_annotations/2.18.0/error_prone_annotations-2.18.0.jar:/home/daniel/.m2/repository/com/google/j2objc/j2objc-annotations/1.3/j2objc-annotations-1.3.jar:/home/daniel/.m2/repository/com/google/errorprone/error_prone_type_annotations/2.18.0/error_prone_type_annotations-2.18.0.jar:/home/daniel/.m2/repository/com/google/errorprone/error_prone_check_api/2.18.0/error_prone_check_api-2.18.0.jar:/home/daniel/.m2/repository/org/checkerframework/dataflow-errorprone/3.27.0/dataflow-errorprone-3.27.0.jar:/home/daniel/.m2/repository/io/github/java-diff-utils/java-diff-utils/4.0/java-diff-utils-4.0.jar:/home/daniel/.m2/repository/org/eclipse/jgit/org.eclipse.jgit/4.4.1.201607150455-r/org.eclipse.jgit-4.4.1.201607150455-r.jar:/home/daniel/.m2/repository/com/google/auto/value/auto-value-annotations/1.9/auto-value-annotations-1.9.jar:/home/daniel/.m2/repository/com/github/kevinstern/software-and-algorithms/1.0/software-and-algorithms-1.0.jar:/home/daniel/.m2/repository/com/github/ben-manes/caffeine/caffeine/3.0.5/caffeine-3.0.5.jar:/home/daniel/.m2/repository/org/pcollections/pcollections/3.1.4/pcollections-3.1.4.jar:/home/daniel/.m2/repository/com/google/auto/auto-common/1.2.1/auto-common-1.2.1.jar:/home/daniel/.m2/repository/com/google/protobuf/protobuf-java/3.19.2/protobuf-java-3.19.2.jar:/home/daniel/.m2/repository/com/google/auto/service/auto-service-annotations/1.0.1/auto-service-annotations-1.0.1.jar:/home/daniel/.m2/repository/javax/inject/javax.inject/1/javax.inject-1.jar: -g -target 17 -source 17 -encoding UTF-8 -Awarns -XDcompilePolicy=simple -Xplugin:ErrorProne -Aannotations -Anolocations"

### no need to make changes below this line, usually

# TODO: compute this list from the names of the ajava files
AJAVA_FILE_LIST=$(cd ${WPI_RESULTS_DIR} && find . -name "*-*.ajava")
CHECKER_LIST=""

if [ -f compute-annos-inferred-out ]; then
    # from https://betterprogramming.pub/24-bashism-to-avoid-for-posix-compliant-shell-scripts-8e7c09e0f49a, in response to a shellcheck error noting that $RANDOM is not POSIX-compliant
    var1=$(date +%s)
    var2=$$
    random="$var1$var2"
    echo "making a backup of compute-annos-inferred-out in compute-annos-inferred-out-${random}"
    mv compute-annos-inferred-out compute-annos-inferred-out-"${random}"
fi

for ajava_filename in ${AJAVA_FILE_LIST};
do
    tmp=${ajava_filename##*-};
    CHECKER_LIST="${CHECKER_LIST} ${tmp%.ajava}"
done
CHECKER_LIST=$(echo "${CHECKER_LIST}" | sort | uniq)

JAVA_FILES=$(cd ${JAVA_SRC_DIR} && find . -name "*.java")

for checker in ${CHECKER_LIST}; do
    # copy the ajava files generated for the relevant checker to the
    # corresponding places in the source tree
    echo "======== RUNNING ANNOTATION STATISTIC FOR INFERRED ANNOTATIONS FROM ${checker} ========"
    for java_file in ${JAVA_FILES}; do
	# strip the ".java" from the end of the file name
	base_filename="${java_file%.*}"
	ajava_file="${WPI_RESULTS_DIR}/${base_filename}-${checker}.ajava"
	if [ -f "${ajava_file}" ]; then
	    cp "${ajava_file}" "${JAVA_SRC_DIR}/${java_file}"
	fi
    done
    # run AnnotationStatistics and append the results to the output file
    eval "${RUN_ANNO_STATS}" >> compute-annos-inferred-out 2>&1
    # reset to the state before doing the copying
    git reset --hard wpi-annotations -- > /dev/null 2>&1
done

# find the lines from AnnotationStatistics listing annotations
echo "====== COMBINED RESULTS ======="
grep "^org.checkerframework" < compute-annos-inferred-out | sort | uniq
